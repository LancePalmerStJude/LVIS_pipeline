# Profiling vector integration sites at single-cell level using scATAC-seq or scMultiome data

Here are the steps for profiling VIS from 10X scATAC-seq/scMultiome data. The main tool we used is EpiVIA (https://github.com/wangwl/epiVIA). The starting point is the fastq files generated by 10X scATAC-seq data. There are 4 fq files: I1, R1, R2 and R3. I1 is the 8 bp sample barcode, R1 is the forward read, R2 is the 16 bp 10x feature barcode and R3 is the reverse read. 

As prerequisites, files from multiple lanes should be merged. Qualtiy control was performed for R1 and R3 (fastqc), reads should be trimmed in case adapters are found. More important, build a bwa index for a modified human genome. The [provirus sequence](https://github.com/jyyulab/LVIS_pipeline/blob/master/provirus_sequence) has to be appended as an additional chromosome.

Step 1 (alignment)
Map the reads to the modified genome by bwa.
```bash
idx=/research/projects/yu3grp/IO_JY/yu3grp/LVXSCID/patients_scATACseq/bwa_index/hg19withpv/hg19wpvidx ##location of the bwa index
input1=P1_scMulti_ATAC_S1_R1.fastq.gz
input2=P1_scMulti_ATAC_S1_R3.fastq.gz
bam_file=P1_scMulti_ATAC_S1_pe.bam
bwa mem -t 4 $idx $input1 $input2 | samtools view -bS - > $bam_file
```

Step 2 (extract the chimeric reads)
Extract the chimeric reads in which one end is mapped to a human chromosome, whereas another end is mapped to the provirus sequence. 
```bash
input=P1_scMulti_ATAC_S1_pe.bam
out=P1_scMulti_ATAC_S1_pe_mated.bam
out_filter1=P1_scMulti_ATAC_S1_pe.mated.filter1.bam
out_filter2=P1_scMulti_ATAC_S1_pe.mated.filter2.bam
out_filter=P1_scMulti_ATAC_S1_pe.mated.filter.bam

samtools view -F 12 $input1 -o $out

###It will get all host-virus pairs
samtools view -h $out | awk '($7 == "chrZ_provirus" && $3!="=") || ($3 == "chrZ_provirus" && $7!="=") || $1 ~ /^@/' | samtools view -bS - > $out1_filter1

###get the host-host, virus-virus pairs with soft clip
samtools view -h $out | awk '($7 == "="  && $6 ~ /S/) || ($7 == "="  && $14 ~ /S/) || $1 ~ /^@/' | samtools view -bS - > $out1_filter2

samtools merge $out_filter $out_filter1 $out_filter2

```

Step 3 (Matching cellular barcodes) 
Extract the cellular barcode for each chimeric read using the R2 fastq file. The barcode is added as an additional tag in the bam file.
